/*
Deployment script for RockRMS_20170710

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.

To Run This, enable SQLCMD MODE via SSMS->Query->SQLCMD Mode
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "RockRMS_20170915"
:setvar DefaultFilePrefix "RockRMS_20170915"
:setvar DefaultDataPath "C:\Databases\"
:setvar DefaultLogPath "C:\Databases\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
PRINT N'Altering [dbo].[_church_ccv_v_All_Next_Steps]...';


GO
ALTER VIEW [dbo].[_church_ccv_v_All_Next_Steps]
AS
WITH CTE AS (

				SELECT [SundayDate]
					   ,CAST( YEAR([SundayDate]) AS varchar(10) ) AS [Year]
					   ,CampusId 
					   ,c.Name AS [Campus]
					   ,CASE WHEN DATEDIFF(year, p.BirthDate, DateTaken ) >= 18 THEN 'Adults'
							WHEN DATEDIFF(year, p.BirthDate, DateTaken ) BETWEEN 0 AND 17 THEN 'Next Gen'
							ELSE 'Adults' END AS [AgeGroup]
					   ,COUNT(st.Id) AS [Count]
				FROM [dbo].[_church_ccv_Steps_StepTaken] st
						INNER JOIN [dbo].[_church_ccv_Steps_StepMeasure] sm ON sm.Id = st.StepMeasureId
						INNER JOIN [dbo].[Campus] c ON c.Id = st.CampusId 
						INNER JOIN [dbo].[PersonAlias] pa ON pa.Id = st.PersonAliasId
						INNER JOIN [dbo].[Person] p ON p.Id = pa.PersonId
				WHERE SundayDate >= '2016-01-01' 
				GROUP BY [SundayDate], 
					     [CampusId], 
						 c.[Name], 
						 CASE WHEN DATEDIFF(year, p.BirthDate, DateTaken ) >= 18 THEN 'Adults'
							WHEN DATEDIFF(year, p.BirthDate, DateTaken ) BETWEEN 0 AND 17 THEN 'Next Gen'
							ELSE 'Adults' END
)

SELECT *
	,ROUND( SUM([CTE].[Count]) OVER (PARTITION BY [CampusId], [CTE].[AgeGroup], [CTE].[Year] ORDER BY SundayDate ROWS UNBOUNDED PRECEDING), 0 ) AS TotalToDate
FROM CTE
GO
PRINT N'Altering [dbo].[_church_ccv_v_AnalyticsFactPurpleAttendance]...';


GO
ALTER VIEW [dbo].[_church_ccv_v_AnalyticsFactPurpleAttendance]
AS
SELECT  a.Id 
		,1 AS [Count]
		,p.Id AS [PersonId]
		,SundayDate
		,a.CampusId 
		,c.Name AS [Campus]
		,cs.Value AS [ConnectionStatus]
  FROM [dbo].[Attendance] a INNER JOIN
  [dbo].[PersonAlias] pa ON pa.AliasPersonId = a.PersonAliasId INNER JOIN
  [dbo].[Person] p ON p.Id = pa.PersonId INNER JOIN
  [dbo].[Campus] c ON c.Id = a.CampusId INNER JOIN
  [dbo].[DefinedValue] cs ON cs.Id = p.ConnectionStatusValueId INNER JOIN
  [dbo].[Group] g ON g.Id = a.GroupId 
  WHERE GroupId = 1971687 AND SundayDate <= GETDATE()
GO
PRINT N'Altering [dbo].[_church_ccv_v_AnalyticsPersonMarketingHistorical]...';


GO
ALTER VIEW [dbo].[_church_ccv_v_AnalyticsPersonMarketingHistorical]
AS
SELECT  p.*
      ,CASE WHEN p.PersonId IN (
			SELECT [dbo].[_church_ccv_Datamart_Person].[PersonId] FROM [dbo].[_church_ccv_Datamart_Person] ) THEN 'True' ELSE 'False' END AS [IsActive]
	  ,CASE WHEN pvc.[Value] IS NULL OR pvc.[Value] = '' THEN 'Unknown' ELSE pvc.[Value] END AS [Previous Church]
	  ,CASE WHEN [pvt].[1137] IS NULL OR [pvt].[1137] = '' THEN 'Unknown' ELSE [pvt].[1137] END AS [Divorced]
	  ,CASE WHEN [pvt].[1119] IS NULL OR [pvt].[1119] = '' THEN 'Unknown' ELSE [pvt].[1119] END AS [Widowed]
	  ,CASE WHEN sov.[Value] IS NULL OR sov.[Value] = '' THEN 'Unknown' ELSE sov.[Value] END AS [SourceOfVisit]
  FROM [dbo].[AnalyticsDimPersonHistorical] p LEFT OUTER JOIN
	(SELECT [dbo].[AttributeValue].[AttributeId], [dbo].[AttributeValue].[EntityId], [dbo].[AttributeValue].[Value]
		FROM [dbo].[AttributeValue]) av
	PIVOT
	( MAX([Value])
	FOR [AttributeId] IN ( [716], [719], [1119], [1137] )
	) AS pvt ON p.PersonId = pvt.EntityId LEFT OUTER JOIN
	[dbo].[DefinedValue] pvc ON pvc.[Guid] = TRY_CAST([716] AS uniqueidentifier) LEFT OUTER JOIN
	[dbo].[DefinedValue] sov ON sov.[Guid] = TRY_CAST([719] AS uniqueidentifier)
	WHERE p.FirstVisit >= '2015-06-19' AND RecordType = 'Person'
GO
PRINT N'Altering [dbo].[_church_ccv_v_General_Fund_Totals]...';


GO

ALTER VIEW [dbo].[_church_ccv_v_General_Fund_Totals]
AS
WITH CTE AS (

		SELECT ad.SundayDate AS [SundayDate]
			  ,CAST( YEAR([SundayDate]) AS varchar(10) ) AS [Year]
			  ,fa.[CampusId] AS [CampusId]
			  ,fa.[Name] AS [Campus]
			  ,SUM(asft.Amount) AS [Amount]

		FROM [dbo].[AnalyticsSourceFinancialTransaction] asft INNER JOIN
		[dbo].[AnalyticsDimDate] ad ON asft.TransactionDateKey = ad.DateKey INNER JOIN
		[dbo].[FinancialAccount] fa ON fa.Id = asft.AccountId

		WHERE ad.[SundayDate] >= '2016-01-01'
				AND asft.AccountId IN (498, 609, 690, 708, 727, 745, 902)
		GROUP BY ad.[SundayDate], 
								 fa.[CampusId], 
								 fa.[Name]
)

SELECT *
	,ROUND( SUM([CTE].[Amount]) OVER (PARTITION BY [CampusId], [CTE].[Year] ORDER BY SundayDate ROWS UNBOUNDED PRECEDING), 0 ) AS TotalToDate
FROM CTE
GO
PRINT N'Altering [dbo].[_church_ccv_v_Missions_Every_Sunday]...';


GO



ALTER VIEW [dbo].[_church_ccv_v_Missions_Every_Sunday]
AS
WITH CTE AS (
SELECT awa.[SundayDate]
      ,awa.[Year]
      ,awa.[CampusId]
	  ,awa.[AgeGroup]
	  ,SUM(ISNULL(mp.[Count], 0)) AS MissionsCount
  FROM [dbo].[_church_ccv_v_Condensed_Next_Gen_AWA] awa LEFT JOIN
  [dbo].[_church_ccv_v_Missions_Participants] mp ON
  awa.SundayDate = mp.SundayDate AND
  awa.CampusId = mp.CampusId AND
  awa.AgeGroup = mp.AgeGroup
  WHERE awa.Year NOT LIKE '%GOAL%'
  GROUP BY awa.[SundayDate], awa.[Year], awa.[CampusId], awa.[AgeGroup]
)

SELECT *
	,ROUND( SUM([CTE].[MissionsCount]) OVER (PARTITION BY [CampusId], [AgeGroup], [Year] ORDER BY SundayDate ROWS UNBOUNDED PRECEDING), 0 ) AS TotalToDate
FROM CTE
GO
PRINT N'Altering [dbo].[_church_ccv_v_Next_Step_Subtotals]...';


GO





ALTER VIEW [dbo].[_church_ccv_v_Next_Step_Subtotals]
AS

WITH CTE AS (

		SELECT	aha.[Date] AS [SundayDate]
				,CAST(YEAR(aha.[Date]) AS varchar(10)) AS [Year]
				,aha.CampusId AS [CampusId]
				,c.[Name] AS [Campus]
				,'Adults' AS [AgeGroup]
				,SUM(aha.TotalPeople) AS [TotalPeople]
				,SUM(aha.PeerLearning) AS [Connect]
				,SUM(aha.Teaching) AS [Coach]
				,SUM(aha.ERA) AS [Worship]
				,SUM(aha.Serving) AS [Serve]
				,SUM(aha.Give) AS [Give]
		FROM [dbo].[_church_ccv_Actions_History_Adult] aha INNER JOIN
		[dbo].[Campus] c ON c.Id = aha.CampusId 
		WHERE [Date] >= '2017-01-01'
		GROUP BY aha.[Date],
				 aha.CampusId,
				 c.Name

	    UNION ALL

		SELECT	ahs.[Date] AS [SundayDate]
				,CAST(YEAR(ahs.[Date]) AS varchar(10)) AS [Year]
				,ahs.CampusId AS [CampusId]
				,c.[Name] AS [Campus]
				,'Students' AS [AgeGroup]
				,SUM(ahs.TotalPeople) AS [TotalPeople]
				,SUM(ahs.PeerLearning) AS [Connect]
				,SUM(ahs.Teaching) AS [Coach]
				,SUM(ahs.ERA) AS [Worship]
				,SUM(ahs.Serving) AS [Serve]
				,SUM(ahs.Give) AS [Give]
		FROM [dbo].[_church_ccv_Actions_History_Student] ahs INNER JOIN
		[dbo].[Campus] c ON c.Id = ahs.CampusId 
		WHERE ahs.[Date] >= '2017-01-01'
		GROUP BY ahs.[Date],
				 ahs.CampusId,
				 c.Name
)

SELECT CTE.SundayDate
	  ,CTE.Year
	  ,CTE.CampusId
	  ,CTE.AgeGroup
	  ,CTE.Connect
	  ,CTE.Coach
	  ,CTE.TotalPeople
	  ,awa.AWA
	  ,CTE.Serve
	  ,CTE.Give 
FROM CTE
INNER JOIN [dbo].[_church_ccv_v_Condensed_Next_Gen_AWA] awa ON 
			awa.SundayDate = CTE.SundayDate AND awa.Year = CTE.Year AND awa.CampusId = CTE.CampusId AND awa.AgeGroup = CTE.AgeGroup
GO
PRINT N'Altering [dbo].[_church_ccv_v_Next_Steps_w_First_Visit]...';


GO






ALTER VIEW [dbo].[_church_ccv_v_Next_Steps_w_First_Visit]
AS

SELECT dp.PersonId
	  ,sm.Title AS [StepTaken]
	  ,st.CampusId
	  ,c.Name AS [Campus]
	  ,[DateTaken]
	  ,dp.FirstVisitDate
	  ,DATEDIFF( day, dp.[FirstVisitDate], [DateTaken]) AS [DaysSinceFV]
	  ,DATEDIFF( week, dp.[FirstVisitDate], [DateTaken]) AS [WeeksSinceFV]
	  ,DATEDIFF( month, dp.[FirstVisitDate], [DateTaken]) AS [MonthsSinceFV]
	  ,DATEDIFF( year, dp.[FirstVisitDate], [DateTaken]) AS [YearsSinceFV]
  FROM [dbo].[_church_ccv_Steps_StepTaken] st INNER JOIN
  [dbo].[_church_ccv_Steps_StepMeasure] sm ON st.StepMeasureId = sm.Id INNER JOIN
  [dbo].[PersonAlias] pa ON st.PersonAliasId = pa.AliasPersonId INNER JOIN
  [dbo].[_church_ccv_Datamart_Person] dp ON dp.PersonId = pa.PersonId INNER JOIN
  [dbo].[Campus] c ON c.Id = st.CampusId 
  WHERE dp.FirstVisitDate >= '2015-06-19' AND [dp].[FirstVisitDate] < DateTaken
GO
PRINT N'Altering [dbo].[_church_ccv_v_Person_Extended_Attributes]...';


GO



ALTER VIEW [dbo].[_church_ccv_v_Person_Extended_Attributes]
AS
SELECT  p.PersonId AS [PersonId]
	  ,CASE WHEN pvc.[Value] IS NULL OR pvc.[Value] = '' THEN 'Unknown' ELSE pvc.[Value] END AS [Previous Church]
	  ,CASE WHEN [1137] IS NULL OR [1137] = '' THEN 'Unknown' ELSE [1137] END AS [Divorced]
	  ,CASE WHEN [1119] IS NULL OR [1119] = '' THEN 'Unknown' ELSE [1119] END AS [Widowed]
	  ,CASE WHEN sov.[Value] IS NULL OR sov.[Value] = '' THEN 'Unknown' ELSE sov.[Value] END AS [SourceOfVisit]
  FROM [dbo].[_church_ccv_Datamart_Person] p LEFT OUTER JOIN
	(SELECT [AttributeId], [EntityId], [Value]
		FROM [AttributeValue]) av
	PIVOT
	( MAX([Value])
	FOR [AttributeId] IN ( [716], [719], [1119], [1137] )
	) AS pvt ON p.PersonId = pvt.EntityId LEFT OUTER JOIN
	[dbo].[DefinedValue] pvc ON pvc.[Guid] = TRY_CAST([716] AS uniqueidentifier) LEFT OUTER JOIN
	[dbo].[DefinedValue] sov ON sov.[Guid] = TRY_CAST([719] AS uniqueidentifier)
GO
PRINT N'Altering [dbo].[_church_ccv_v_Public_Baptisms_At_CCV]...';


GO







ALTER VIEW [dbo].[_church_ccv_v_Public_Baptisms_At_CCV]
AS
WITH CTE AS (
SELECT [SundayDate]
	  ,CAST(YEAR(SundayDate) AS varchar(10)) AS [Year]
      ,ISNULL(a.[CampusId], 1) AS [CampusId]
	  ,CASE WHEN DATEDIFF( year, p.BirthDate, a.SundayDate ) >= 18 THEN 'Adults'
			WHEN DATEDIFF( year, p.BirthDate, a.SundayDate ) BETWEEN 0 AND 17 THEN 'Students'
			ELSE 'Adults' END AS AgeGroup 
	  ,COUNT(a.[Id]) AS [BaptismCount]
  FROM [dbo].[Attendance] a INNER JOIN
  [Group] g ON a.GroupId = g.Id INNER JOIN
  [PersonAlias] pa ON pa.Id = a.PersonAliasId INNER JOIN
  [Person] p ON p.Id = pa.PersonId LEFT JOIN
  [Campus] c ON c.Id = a.CampusId
  WHERE g.GroupTypeId = 58 AND SundayDate >= '2016-01-01'
  GROUP BY  SundayDate
  			,a.CampusId
			,ISNULL(c.[Name], 'Peoria')
			,CASE WHEN DATEDIFF( year, p.BirthDate, a.SundayDate ) >= 18 THEN 'Adults'
			WHEN DATEDIFF( year, p.BirthDate, a.SundayDate ) BETWEEN 0 AND 17 THEN 'Students'
			ELSE 'Adults' END
)

SELECT *
	,ROUND( SUM(BaptismCount) OVER (PARTITION BY [CampusId], [AgeGroup], [Year] ORDER BY SundayDate ROWS UNBOUNDED PRECEDING), 0 ) AS TotalToDate
FROM CTE
GO
PRINT N'Altering [dbo].[_church_ccv_v_Baptisms_Every_Sunday]...';


GO


ALTER VIEW [dbo].[_church_ccv_v_Baptisms_Every_Sunday]
AS
WITH CTE AS (
SELECT awa.[SundayDate]
      ,awa.[Year]
      ,awa.[CampusId]
	  ,awa.[AgeGroup]
	  ,SUM(ISNULL(bapt.BaptismCount, 0)) AS BaptismCount
  FROM [dbo].[_church_ccv_v_Condensed_Next_Gen_AWA] awa LEFT JOIN
  [dbo].[_church_ccv_v_Public_Baptisms_At_CCV] bapt ON
			bapt.SundayDate = awa.SundayDate AND
			bapt.Year = awa.Year AND
			bapt.CampusId = awa.CampusId AND
			bapt.AgeGroup = awa.AgeGroup
  WHERE awa.Year NOT LIKE '%GOAL%'
  GROUP BY awa.[SundayDate], awa.[Year], awa.[CampusId], awa.[AgeGroup]
)

SELECT *
	,ROUND( SUM([CTE].[BaptismCount]) OVER (PARTITION BY [CampusId], [AgeGroup], [Year] ORDER BY SundayDate ROWS UNBOUNDED PRECEDING), 0 ) AS TotalToDate
FROM CTE
GO
PRINT N'Update complete.';


GO
